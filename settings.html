<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Warehouse Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
      window.tailwind = window.tailwind || {};
      window.tailwind.config = { darkMode: 'class' };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="src/output.css">
<script>
// Early theme initialization
(function(){
  try {
    var saved = localStorage.getItem('theme');
    if (saved === 'dark') {
      document.documentElement.classList.add('dark');
    }
  } catch (e) {}
})();
</script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans">
    <div class="flex">
        <!-- Sidebar -->
        <div class="sidebar bg-blue-800 dark:bg-gray-900 text-white w-64 flex flex-col h-screen fixed inset-y-0 left-0 z-40 transform transition-transform duration-200 ease-in-out -translate-x-full md:translate-x-0 md:relative md:transform-none">
            <div class="p-4 flex items-center justify-between border-b border-blue-700">
                <div class="flex items-center">
                    <i class="fas fa-warehouse text-2xl mr-3"></i>
                    <span class="font-bold text-xl">WarehousePro</span>
                </div>
                <button id="mobileCloseSidebar" class="md:hidden p-2 text-xl text-white/90 hover:text-white focus:outline-none" aria-label="Close menu">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-4 flex items-center justify-between border-b border-blue-700">
                <div class="flex items-center">
                    <img src="https://ui-avatars.com/api/?name=User&background=random" class="w-10 h-10 rounded-full mr-3" alt="User">
                    <div class="sidebar-text">
                        <div class="font-medium user-name">Loading...</div>
                        <div id="userRoleText" class="text-xs font-semibold px-2 rounded mt-1 inline-block"></div>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 overflow-y-auto py-4">
                <div class="px-4 space-y-2">
                    <a href="index.html" class="nav-item flex items-center px-3 py-2 hover:bg-blue-700">
                        <i class="fas fa-tachometer-alt mr-3"></i> 
                        <span class="sidebar-text">Dashboard</span>
                    </a>
                    <a href="inventory.html" class="nav-item flex items-center px-3 py-2 hover:bg-blue-700">
                        <i class="fas fa-boxes mr-3"></i>
                        <span class="sidebar-text">Inventory</span>
                    </a>
                    <a href="suppliers.html" class="nav-item flex items-center px-3 py-2 hover:bg-blue-700">
                        <i class="fas fa-truck mr-3"></i> 
                        <span class="sidebar-text">Suppliers</span>
                    </a>
                    <a href="orders.html" class="nav-item flex items-center px-3 py-2 hover:bg-blue-700">
                        <i class="fas fa-shopping-cart mr-3"></i> 
                        <span class="sidebar-text">Orders</span>
                    </a>
                    <a href="transactions.html" class="nav-item flex items-center px-3 py-2 rounded-lg hover:bg-blue-700 text-white">
                        <i class="fas fa-exchange-alt mr-3"></i>
                        <span class="sidebar-text">Transactions</span>
                    </a>
                    <a href="user.html" class="nav-item flex items-center px-3 py-2 rounded-lg hover:bg-blue-700 text-white">
                        <i class="fas fa-users mr-3"></i>
                        <span class="sidebar-text">Users</span>
                    </a>
                    <a href="settings.html" class="nav-item flex items-center px-3 py-2 rounded-lg bg-blue-700 text-white">
                        <i class="fas fa-cog mr-3"></i>
                        <span class="sidebar-text">Settings</span>
                    </a>
                </div>
            </nav>

            <div class="p-4 border-t border-blue-700">
                <a href="#" id="logoutBtn" class="flex items-center text-white hover:text-blue-200">
                    <i class="fas fa-sign-out-alt mr-3"></i>
                    <span class="sidebar-text">Logout</span>
                </a>
            </div>
        </div>

        <!-- Mobile Overlay -->
        <div id="mobileOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

        <!-- Main Content -->
        <div class="flex-1 p-6">
            <header class="bg-white dark:bg-gray-800 shadow-sm md:sticky md:top-0 relative z-20">
                <div class="flex items-center justify-between px-6 py-4">
                    <div class="flex items-center">
                        <button id="mobileToggleSidebar" class="mr-4 md:hidden p-2 text-2xl text-gray-800 dark:text-gray-200 z-50" aria-label="Open menu"><i class="fas fa-bars"></i></button>
                        <h1 class="text-2xl font-bold dark:text-gray-100">Settings</h1>
                    </div>
                </div>
            </header>

            <!-- Dark Mode -->
            <div class="bg-white dark:bg-gray-800 dark:text-gray-100 p-6 rounded-lg shadow mb-6">
                <h2 class="text-xl font-bold mb-4">Appearance</h2>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-medium">Dark Mode</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Toggle website theme between light and dark</p>
                    </div>
                    <button id="darkModeToggle" class="px-4 py-2 rounded bg-gray-900 text-white dark:bg-gray-200 dark:text-gray-900">
                        Enable Dark Mode
                    </button>
                </div>
            </div>

            <!-- Profile Picture Upload -->
            <div class="bg-white dark:bg-gray-800 dark:text-gray-100 p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">Change Profile Picture</h2>
                <form id="profilePictureForm" enctype="multipart/form-data">
                    <div class="mb-4">
                        <label for="profilePicture" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Upload New Profile Picture</label>
                        <input type="file" id="profilePicture" name="profilePicture" accept="image/*" class="mt-1 block w-full text-sm text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer focus:outline-none dark:bg-gray-700">
                    </div>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Upload</button>
                </form>
                <p id="uploadStatus" class="mt-4 text-sm text-gray-600 dark:text-gray-400"></p>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // ===== HIGHLIGHT ACTIVE MENU =====
    const currentPage = window.location.pathname.split('/').pop();
    document.querySelectorAll('.nav-item').forEach(item => {
        const href = item.getAttribute('href');
        if (href && href === currentPage) {
            item.classList.add('bg-blue-700');
        } else {
            item.classList.remove('bg-blue-700');
        }
    });

    // ===== DARK MODE TOGGLE =====
    function updateDarkButtonLabel() {
        const btn = document.getElementById('darkModeToggle');
        if (!btn) return;
        const isDark = document.documentElement.classList.contains('dark');
        btn.textContent = isDark ? 'Disable Dark Mode' : 'Enable Dark Mode';
    }

    const darkBtn = document.getElementById('darkModeToggle');
    if (darkBtn) {
        updateDarkButtonLabel();
        darkBtn.addEventListener('click', function() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            try { 
                localStorage.setItem('theme', isDark ? 'dark' : 'light'); 
            } catch (e) {}
            updateDarkButtonLabel();
        });
    }

    // ===== PROFILE PICTURE UPLOAD =====
    const profileForm = document.getElementById('profilePictureForm');
    if (profileForm) {
        profileForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('profilePicture');
            const statusEl = document.getElementById('uploadStatus');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                statusEl.textContent = 'Please select a file to upload.';
                statusEl.className = 'mt-4 text-sm text-red-600';
                return;
            }

            const formData = new FormData();
            formData.append('profile_picture', fileInput.files[0]); // ✅ PERBAIKAN: Nama field harus 'profile_picture'

            statusEl.textContent = 'Uploading...';
            statusEl.className = 'mt-4 text-sm text-blue-600';

            try {
                const response = await fetch('settings.php', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    statusEl.textContent = 'Profile picture updated successfully!';
                    statusEl.className = 'mt-4 text-sm text-green-600';
                    
                    // Update avatar in sidebar
                    const avatarImage = document.querySelector('img[alt="User"]');
                    if (avatarImage && data.profile_picture) {
                        avatarImage.src = data.profile_picture + '?t=' + Date.now();
                    }
                    
                    // Reset form
                    profileForm.reset();
                    
                } else {
                    statusEl.textContent = 'Upload failed: ' + (data.message || 'Unknown error');
                    statusEl.className = 'mt-4 text-sm text-red-600';
                }
            } catch (error) {
                console.error('Upload error:', error);
                statusEl.textContent = 'Upload failed. Please try again.';
                statusEl.className = 'mt-4 text-sm text-red-600';
            }
        });
    }

    // ===== LOGOUT =====
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            fetch('auth.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=logout'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = 'index.html';
                } else {
                    alert('Logout failed: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Logout failed. Please try again.');
            });
        });
    }

    // ===== CHECK LOGIN STATUS & UPDATE USER INFO =====
fetch('auth.php', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: 'action=check_status',
})
.then(response => response.json())
.then(data => {
    console.log('✅ Auth Response:', data); // Debug
    
    if (data.success && data.logged_in) {
        // ✅ Update user full name
        const userNameElements = document.querySelectorAll('.user-name');
        userNameElements.forEach(element => {
            element.textContent = data.user.full_name || 'User';
        });

        // ✅ Update avatar - PRIORITAS: Profile Picture > UI Avatars
        const avatarImage = document.querySelector('img[alt="User"]');
        if (avatarImage) {
            if (data.user.profile_picture && data.user.profile_picture.startsWith('uploads/')) {
                // Gunakan uploaded profile picture
                avatarImage.src = data.user.profile_picture + '?t=' + Date.now();
            } else if (data.user.profile_picture && data.user.profile_picture.startsWith('http')) {
                // Gunakan URL langsung (UI Avatars)
                avatarImage.src = data.user.profile_picture;
            } else {
                // Fallback ke UI Avatars
                const encodedName = encodeURIComponent(data.user.full_name || 'User');
                avatarImage.src = `https://ui-avatars.com/api/?name=${encodedName}&background=random`;
            }
        }

        // ✅ Update role badge
        const userRoleText = document.getElementById('userRoleText');
        if (userRoleText) {
            userRoleText.textContent = data.user.role || 'user';
            if (data.user.role === 'admin') {
                userRoleText.style.backgroundColor = 'green';
                userRoleText.style.color = 'white';
            } else {
                userRoleText.style.backgroundColor = 'yellow';
                userRoleText.style.color = 'black';
            }
        }
        
        // ✅ Hide user management for non-admin
        const userManagementLink = document.querySelector('a[href="user.html"]');
        if (userManagementLink && data.user.role !== 'admin') {
            const fullNameLower = (data.user.full_name || '').toLowerCase().trim();
            if (fullNameLower !== 'bryan phillip sumarauw') {
                userManagementLink.style.display = 'none';
            }
        }
    } else {
        // Redirect ke login jika tidak authenticated
        window.location.href = 'index.html';
    }
})
.catch(error => {
    console.error('❌ Auth Error:', error);
});

}); // END DOMContentLoaded

// ===== MOBILE SIDEBAR TOGGLE =====
(function(){
  const sidebar = document.querySelector('.sidebar');
  const toggleBtn = document.getElementById('mobileToggleSidebar');
  const overlay = document.getElementById('mobileOverlay');
  const closeBtn = document.getElementById('mobileCloseSidebar');
  
  if (!sidebar || !toggleBtn || !overlay) return;

  function openSidebar(){
    sidebar.classList.remove('-translate-x-full');
    overlay.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
    toggleBtn.setAttribute('aria-expanded','true');
  }
  
  function closeSidebar(){
    sidebar.classList.add('-translate-x-full');
    overlay.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
    toggleBtn.setAttribute('aria-expanded','false');
  }
  
  function isMobile(){
    return window.matchMedia('(max-width: 767px)').matches;
  }

  toggleBtn.addEventListener('click', function(e){
    e.preventDefault();
    e.stopPropagation();
    if (!isMobile()) return;
    const isOpen = !sidebar.classList.contains('-translate-x-full');
    if (isOpen) {
      closeSidebar();
    } else {
      openSidebar();
    }
  });
  
  overlay.addEventListener('click', closeSidebar);
  if (closeBtn) closeBtn.addEventListener('click', closeSidebar);

  window.addEventListener('resize', function(){
    if (!isMobile()) {
      sidebar.classList.remove('-translate-x-full');
      overlay.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      toggleBtn.setAttribute('aria-expanded','false');
    } else {
      sidebar.classList.add('-translate-x-full');
      overlay.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      toggleBtn.setAttribute('aria-expanded','false');
    }
  });

  if (isMobile()) {
    sidebar.classList.add('-translate-x-full');
    overlay.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
    toggleBtn.setAttribute('aria-expanded','false');
  }
})();
</script>

</body>
</html>