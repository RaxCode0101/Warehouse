<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex">
    <!-- Sidebar -->
    <div class="sidebar bg-blue-800 text-white w-64 flex flex-col h-screen fixed">
        <div class="p-4 flex items-center border-b border-blue-700">
            <div class="flex items-center">
                <i class="fas fa-warehouse text-2xl mr-3"></i>
                <span class="logo-text font-bold text-xl">Stokku</span>
            </div>
            <button id="toggleSidebar" class="ml-auto md:hidden">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-4 flex items-center justify-between border-b border-blue-700">
            <div class="flex items-center">
                <img src="https://ui-avatars.com/api/?name=User&background=random" class="w-10 h-10 rounded-full mr-3" alt="User">
                <div class="sidebar-text">
                    <div class="font-medium user-name">User</div>
                    <div id="userRoleText" class="text-xs font-semibold px-2 rounded mt-1 inline-block"></div>
                </div>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4">
            <div class="px-4 space-y-2">
                <a href="index.html" class="nav-item flex items-center px-3 py-2 rounded-lg hover:bg-blue-700 text-white">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                <a href="inventory.html" class="nav-item flex items-center px-3 py-2 rounded-lg hover:bg-blue-700 text-white">
                    <i class="fas fa-boxes mr-3"></i>
                    <span class="sidebar-text">Inventory</span>
                </a>
                <a href="suppliers.html" class="nav-item flex items-center px-3 py-2 rounded-lg hover:bg-blue-700 text-white">
                    <i class="fas fa-truck mr-3"></i>
                    <span class="sidebar-text">Suppliers</span>
                </a>
                <a href="orders.html" class="nav-item flex items-center px-3 py-2 rounded-lg hover:bg-blue-700 text-white">
                    <i class="fas fa-shopping-cart mr-3"></i>
                    <span class="sidebar-text">Orders</span>
                </a>
                <a href="transactions.html" class="nav-item flex items-center px-3 py-2 rounded-lg hover:bg-blue-700 text-white">
                    <i class="fas fa-exchange-alt mr-3"></i>
                    <span class="sidebar-text">Transactions</span>
                </a>
                <a href="user.html" class="nav-item flex items-center px-3 py-2 rounded-lg hover:bg-blue-700 text-white">
                    <i class="fas fa-users mr-3"></i>
                    <span class="sidebar-text">Users</span>
                </a>
                <a href="settings.html" class="nav-item flex items-center px-3 py-2 rounded-lg hover:bg-blue-700 text-white">
                    <i class="fas fa-cog mr-3"></i>
                    <span class="sidebar-text">Settings</span>
                </a>
                <a href="profile.html" class="nav-item flex items-center px-3 py-2 rounded-lg hover:bg-blue-700 text-white">
                    <i class="fa-solid fa-user mr-3"></i>
                    <span class="sidebar-text">Profile</span>
                </a>
            </div>
        </nav>

        <div class="p-4 border-t border-blue-700">
            <a href="#" id="logoutBtn" class="flex items-center text-white hover:text-blue-200">
                <i class="fas fa-sign-out-alt mr-3"></i>
                <span class="sidebar-text">Logout</span>
            </a>
        </div>
        <script>
        // Highlight active menu based on current page
        document.addEventListener('DOMContentLoaded', function() {
            const currentPage = window.location.pathname.split('/').pop();
            document.querySelectorAll('.nav-item').forEach(item => {
                const href = item.getAttribute('href');
                if (href && href === currentPage) {
                    item.classList.add('bg-blue-700');
                } else {
                    item.classList.remove('bg-blue-700');
                }
            });
        });

        // Handle logout
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            fetch('auth.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=logout'
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    // Redirect to login page (index.html) after logout
                    window.location.href = 'index.html';
                } else {
                    alert('Logout failed: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Logout failed. Please try again.');
            });
        });

                    // Check login status on page load
                fetch('auth.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=check_status'
                })
                .then(response => response.json())
                    .then(data => {
                        if (data.success && data.logged_in) {
                            // Update user information
                            const userNameElements = document.querySelectorAll('.user-name');
                            userNameElements.forEach(element => {
                                element.textContent = data.user.full_name; // Update with user's full name
                            });

                   // Update role text and style
                   const userRoleText = document.getElementById('userRoleText');
                            if (userRoleText) {
                                userRoleText.textContent = data.user.role;
                                if (data.user.role === 'admin') {
                                    userRoleText.classList.remove('bg-yellow-300', 'text-yellow-800');
                                    userRoleText.classList.add('bg-green-300', 'text-green-800');
                                } else {
                                    userRoleText.classList.remove('bg-green-300', 'text-green-800');
                                    userRoleText.classList.add('bg-yellow-300', 'text-yellow-800');
                                }
                            } 
                            
                            // Update avatar dynamically
                            const avatarImage = document.querySelector('img[alt="User"]');
                            avatarImage.src = data.user.profile_picture; // Use profile picture from server
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
</script>
    </div>
    <!-- Main Content -->
    <div class="flex-1 flex flex-col items-center justify-center ml-64">
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md mt-10">
            <form id="profilePictureForm" class="flex flex-col items-center mb-6 space-y-2">
<img id="profilePicture" src="https://ui-avatars.com/api/?name=User&size=128" alt="Profile Picture" class="w-32 h-32 rounded-full mb-4 border-4 border-blue-200 object-cover">
<input type="file" id="profilePictureInput" name="profilePicture" accept="image/*" class="mb-2 w-full" style="max-width: 250px;">
<button type="submit" id="btnProfilePicturePic" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600">Upload Foto</button>
<div id="profilePicMsg" class="mt-1 text-center text-sm"></div>
                
                <div class="w-full">
                    <label for="inputUsername" class="block text-gray-700">Username</label>
                    <input type="text" id="inputUsername" class="w-full border border-gray-300 rounded px-3 py-2" required>
                </div>
                <div class="w-full">
                    <label for="inputEmail" class="block text-gray-700">Email</label>
                    <input type="email" id="inputEmail" class="w-full border border-gray-300 rounded px-3 py-2" required>
                </div>
                <div class="w-full">
                    <label for="inputPhone" class="block text-gray-700">No Telp</label>
                    <input type="text" id="inputPhone" class="w-full border border-gray-300 rounded px-3 py-2" required>
                </div>
                <div class="w-full">
                    <label for="inputPlace" class="block text-gray-700">Tempat</label>
                    <input type="text" id="inputPlace" class="w-full border border-gray-300 rounded px-3 py-2" required>
                </div>
                <div class="w-full">
                    <label for="inputBirth" class="block text-gray-700">Tanggal Lahir</label>
                    <input type="date" id="inputBirth" class="w-full border border-gray-300 rounded px-3 py-2" required>
                </div>
                <div class="w-full">
                    <label for="inputAge" class="block text-gray-700">Umur</label>
                    <input type="text" id="inputAge" class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100" readonly>
                </div>
                <button type="submit" id="btnUpdateProfile" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Update Data</button>
                <div id="profileUpdateMsg" class="mt-2 text-center text-sm"></div>
            </form>
            <hr class="my-6">
            <h3 class="text-lg font-semibold mb-2">Ubah Password</h3>
            <form id="updatePasswordForm" class="space-y-4">
                <div>
                    <label for="oldPassword" class="block text-gray-700">Password Lama</label>
                    <input type="password" id="oldPassword" class="w-full border border-gray-300 rounded px-3 py-2" required>
                </div>
                <div>
                    <label for="newPassword" class="block text-gray-700">Password Baru</label>
                    <input type="password" id="newPassword" class="w-full border border-gray-300 rounded px-3 py-2" required>
                </div>
                <div>
                    <label for="confirmPassword" class="block text-gray-700">Konfirmasi Password Baru</label>
                    <input type="password" id="confirmPassword" class="w-full border border-gray-300 rounded px-3 py-2" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Update Password</button>
            </form>
            <div id="passwordUpdateMsg" class="mt-4 text-center text-sm"></div>
        </div>
    </div>
    <script>
// Handle upload profile picture
document.getElementById('profilePictureForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const fileInput = document.getElementById('profilePictureInput');
    const msgDiv = document.getElementById('profilePicMsg');
    msgDiv.textContent = '';
    
    if (!fileInput.files || !fileInput.files[0]) {
        msgDiv.textContent = 'Pilih file gambar terlebih dahulu!';
        msgDiv.className = 'mt-1 text-center text-sm text-red-600';
        return;
    }
    const formData = new FormData();
    formData.append('action', 'upload_profile_picture');
    formData.append('profilePicture', fileInput.files[0]);
    try {
        const res = await fetch('auth.php', {
            method: 'POST',
            body: formData
        });
        const result = await res.json();
        if (result.success && result.newProfilePictureUrl) {
            const newUrl = result.newProfilePictureUrl + '?t=' + Date.now();
            document.getElementById('profilePicture').src = newUrl;
            // Update sidebar image in profile.html after upload
            const sidebarImg = document.querySelector('.sidebar img[alt="User"]');
            if (sidebarImg) sidebarImg.src = newUrl;
            // Simpan ke localStorage agar halaman lain bisa akses tanpa reload
            localStorage.setItem('profile_picture_url', newUrl);
            msgDiv.textContent = 'Foto profil berhasil diupdate!';
            msgDiv.className = 'mt-1 text-center text-sm text-green-600';
        } else {
            msgDiv.textContent = result.message || 'Gagal upload foto profil!';
            msgDiv.className = 'mt-1 text-center text-sm text-red-600';
        }
    } catch (err) {
        msgDiv.textContent = 'Gagal upload foto profil!';
        msgDiv.className = 'mt-1 text-center text-sm text-red-600';
    }
});

// Preview gambar sebelum upload
document.getElementById('profilePictureInput').addEventListener('change', function(e) {
    if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = function(ev) {
            document.getElementById('profilePicture').src = ev.target.result;
        };
        reader.readAsDataURL(this.files[0]);
    }
});

    // Placeholder: fetch user profile data (replace with real AJAX if needed)
    document.addEventListener('DOMContentLoaded', async function() {
        // Ambil foto profil dari localStorage jika ada
        const localProfilePic = localStorage.getItem('profile_picture_url');
        if (localProfilePic) {
            document.getElementById('profilePicture').src = localProfilePic;
            var sidebarImg = document.querySelector('.sidebar img[alt="User"]');
            if (sidebarImg) sidebarImg.src = localProfilePic;
        }
        let isAdmin = false;
        try {
            // Cek role user
            const statusRes = await fetch('auth.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'action=check_status'
            });
            const statusData = await statusRes.json();
            if (statusData.success && statusData.logged_in && (statusData.user.role === 'admin' || statusData.user.role === 'user')) {
                isAdmin = true;
            }
            // Fetch data profil
            const response = await fetch('profile.php');
            const result = await response.json();
            if (result.success && result.data) {
                const user = result.data;
                document.getElementById('inputUsername').value = user.username || '';
                document.getElementById('inputEmail').value = user.email || '';
                document.getElementById('inputPhone').value = user.phone || '';
                document.getElementById('inputPlace').value = user.place || '';
                document.getElementById('inputBirth').value = user.birth_date || '';
                document.getElementById('inputAge').value = user.umur !== null ? user.umur + ' tahun' : '';
                // Jika localStorage tidak ada, pakai dari server
                if (!localProfilePic) {
                    document.getElementById('profilePicture').src = user.profile_picture || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.username || 'User') + '&size=128';
                    var sidebarImg = document.querySelector('.sidebar img[alt="User"]');
                    if (sidebarImg) sidebarImg.src = user.profile_picture || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.username || 'User') + '&size=128';
                }
                // Sidebar username & role & foto
                document.querySelector('.user-name').textContent = user.username || '-';
                document.getElementById('userRoleText').textContent = statusData.user.role || '-';
                if (statusData.user.role === 'admin') {
                    document.getElementById('userRoleText').className = 'text-xs font-semibold px-2 rounded mt-1 inline-block bg-green-300 text-green-800';
                } else {
                    document.getElementById('userRoleText').className = 'text-xs font-semibold px-2 rounded mt-1 inline-block bg-yellow-300 text-yellow-800';
                }
                // Enable/disable input sesuai role (admin/user bisa edit)
                [
                    'inputUsername', 'inputEmail', 'inputPhone', 'inputPlace', 'inputBirth'
                ].forEach(id => {
                    document.getElementById(id).disabled = !isAdmin;
                });
                // Always show upload button for all roles
                document.getElementById('btnUpdateProfile').style.display = isAdmin ? '' : 'none';
                document.getElementById('btnProfilePicturePic').style.display = '';
            }
        } catch (err) {
            // fallback: tampilkan placeholder
        }
        // Update umur otomatis saat tanggal lahir diubah
        document.getElementById('inputBirth').addEventListener('input', function() {
            const birth = this.value;
            if (birth) {
                const birthDate = new Date(birth);
                const now = new Date();
                let age = now.getFullYear() - birthDate.getFullYear();
                const m = now.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && now.getDate() < birthDate.getDate())) {
                    age--;
                }
                document.getElementById('inputAge').value = age + ' tahun';
            } else {
                document.getElementById('inputAge').value = '';
            }
        });
    });

    // Handle update profile form
    document.getElementById('updateProfileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const msgDiv = document.getElementById('profileUpdateMsg');
        msgDiv.textContent = '';
        const username = document.getElementById('inputUsername').value.trim();
        const email = document.getElementById('inputEmail').value.trim();
        const phone = document.getElementById('inputPhone').value.trim();
        const place = document.getElementById('inputPlace').value.trim();
        const birth_date = document.getElementById('inputBirth').value.trim();
        const payload = {
            action: 'update_profile',
            username, email, phone, place, birth_date
        };
        try {
            const res = await fetch('profile.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            if (result.success) {
                msgDiv.textContent = 'Data profil berhasil diupdate!';
                msgDiv.className = 'mt-2 text-center text-sm text-green-600';
            } else {
                msgDiv.textContent = result.message || 'Gagal update data profil!';
                msgDiv.className = 'mt-2 text-center text-sm text-red-600';
            }
        } catch (err) {
            msgDiv.textContent = 'Gagal update data profil!';
            msgDiv.className = 'mt-2 text-center text-sm text-red-600';
        }
    });

    // Handle update password form
    document.getElementById('updatePasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const oldPassword = document.getElementById('oldPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const msgDiv = document.getElementById('passwordUpdateMsg');
        msgDiv.textContent = '';
        if (newPassword !== confirmPassword) {
            msgDiv.textContent = 'Konfirmasi password baru tidak cocok!';
            msgDiv.className = 'mt-4 text-center text-sm text-red-600';
            return;
        }
        // Placeholder: AJAX call to update password
        // Replace with real AJAX call to backend
        setTimeout(function() {
            msgDiv.textContent = 'Password berhasil diupdate!';
            msgDiv.className = 'mt-4 text-center text-sm text-green-600';
            document.getElementById('updatePasswordForm').reset();
        }, 1000);
    });
    </script>
</body>
</html>
